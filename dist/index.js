"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _bluebird=_interopRequireDefault(require("bluebird")),_lodash=_interopRequireDefault(require("lodash")),_semver=_interopRequireDefault(require("semver")),_debugnyan=_interopRequireDefault(require("debugnyan")),_parser=_interopRequireDefault(require("./parser")),_requester=_interopRequireDefault(require("./requester")),_drivers=_interopRequireDefault(require("./drivers")),_request=_interopRequireDefault(require("./request")),_dsnParser=_interopRequireDefault(require("./dsnParser"));function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}class Client{constructor(a){const{baseUrl:b,loggerName:c,driverName:d,timeout:e,returnHeaders:f,strictSSL:g,auth:h,version:i}=(0,_dsnParser.default)(a),j=_drivers.default[d];if(!j)throw new Error(`${d} is not supported, yet.`);this.driver=j,this.baseUrl=b,this.timeout=e,this.returnHeaders=f,this.strictSSL=g,this.auth=h,this.hasNamedParametersSupport=!1;let k=[];if(i){const a=/[0-9]+\.[0-9]+\.[0-9]+/.exec(i);if(!a)throw new Error(`Invalid Version "${i}"`,{version:i});const[b]=a;"bitcoin"===this.driver&&(this.hasNamedParametersSupport=_semver.default.satisfies(b,">=0.14.0")),k=_lodash.default.chain(j.methods).pickBy(a=>!_semver.default.satisfies(b,a.version)).keys().value()}const l=(0,_request.default)(j,(0,_debugnyan.default)(c));this.request=_bluebird.default.promisifyAll(l.defaults({baseUrl:this.baseUrl,strictSSL:this.strictSSL,timeout:this.timeout}),{multiArgs:!0}),this.requester=new _requester.default({driver:j,unsupported:k,version:i}),this.parser=new _parser.default({driver:j,headers:this.returnHeaders}),_lodash.default.forOwn(j.methods,(a,b)=>{const c=j.formatter.objMethod(b);this[c]=_lodash.default.partial(this.command,b)})}command(...a){let b,c,d=_lodash.default.tail(a);const e=_lodash.default.head(a),f=_lodash.default.last(a);return _lodash.default.isFunction(f)&&(c=f,d=_lodash.default.dropRight(d)),this.hasNamedParametersSupport&&1===d.length&&_lodash.default.isPlainObject(d[0])&&(d=d[0]),_bluebird.default.try(()=>(b=Array.isArray(e)?e.map((a,b)=>this.requester.prepare({method:a.method,params:a.params,suffix:b})):this.requester.prepare({method:e,params:d}),this.request.postAsync({auth:_lodash.default.pickBy(this.auth,_lodash.default.identity),body:JSON.stringify(b),uri:"/"}).bind(this).then((...a)=>this.parser.rpc(b,...a)))).asCallback(c)}}var _default=Client;exports.default=_default,module.exports=Client;